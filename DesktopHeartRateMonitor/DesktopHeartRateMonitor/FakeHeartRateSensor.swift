//
//  FakeHeartRateSensor.swift
//  DesktopHeartRateMonitor
//
//  Created by Ludwig Schubert on 11/21/16.
//  Copyright © 2016 Ludwig Schubert. All rights reserved.
//

import Foundation

class FakeHeartRateSensor : HeartRateSensor {

  private var timer : Timer?
  private var count = 0
  private let countBeforeSlowBeats = 148

  override init() {
    super.init()
    timer = Timer(timeInterval: 1.2,
                  target: self,
                  selector: #selector(FakeHeartRateSensor.fakeHeartBeat),
                  userInfo: nil,
                  repeats: true)
  }

  override func connect() {
    RunLoop.main.add(timer!, forMode: .defaultRunLoopMode)
  }

  func fakeHeartBeat() {
    guard let delegate = maybeDelegate else {
      return
    }


    let fakeHeartRate = recordedHRs[count]
    let fakeRR = recordedRRs[count]
    let hrInfo = HeartRateInfo(heartRate: fakeHeartRate,
                               rr: fakeRR,
                               sensorDetected: true,
                               energyExpended: nil,
                               date: Date())
    delegate.didReceive(heartRateInfo: hrInfo, sender: self);
    count += 1
    if count < countBeforeSlowBeats {
      fakeHeartBeat() // get calibration out of the way quickly
    }
  }

  private func gaussian(_ µ: Double = 0, _ σ: Double = 1.0) -> Double {
    //Box-Muller transformation; polar form for numerical stability
    var x1 : Double
    var x2 : Double
    var w  : Double
//    var y1 : Double

    repeat {
      x1 = 2.0 * drand48() - 1.0;
      x2 = 2.0 * drand48() - 1.0;
      w = x1 * x1 + x2 * x2;
    } while ( w >= 1.0 );

    w = sqrt( (-2.0 * log( w ) ) / w );
    let y1 = x1 * w;

    return y1 * σ + µ
  }

  let recordedHRs = [76, 77, 76, 76, 78, 78, 78, 81, 85, 88, 89, 92, 93, 94, 93, 93, 92, 92, 92, 90, 88, 88, 88, 89, 90, 90, 90, 90, 86, 84, 82, 82, 82, 84, 85, 85, 84, 84, 83, 83, 83, 83, 83, 84, 86, 88, 88, 87, 87, 85, 84, 84, 85, 86, 86, 87, 88, 88, 88, 88, 84, 83, 83, 83, 83, 85, 85, 85, 83, 82, 83, 83, 83, 83, 83, 82, 82, 81, 80, 79, 79, 79, 80, 80, 80, 79, 77, 76, 75, 74, 73, 73, 74, 74, 74, 76, 76, 76, 76, 76, 77, 77, 77, 80, 80, 80, 80, 78, 78, 77, 78, 79, 79, 80, 81, 83, 85, 88, 91, 92, 92, 92, 92, 89, 86, 85, 85, 85, 83, 80, 78, 76, 75, 74, 74, 74, 76, 77, 80, 82, 86, 86, 86, 86, 86, 85, 84, 83, 84, 85, 87, 86, 86, 86, 83, 81, 80, 79, 78, 78, 77, 77, 78, 78, 78, 77, 76, 75, 74, 75, 75, 74, 74, 75, 76, 75, 74, 74, 73, 73, 75, 75, 77, 78, 78, 78, 78, 77, 76, 76, 77, 77, 77, 77, 76, 77, 77, 77, 78, 78, 79, 79, 80, 81, 79, 78, 78, 77, 77, 77, 78, 78, 78, 78, 77, 77, 76, 76, 76, 77, 77, 79, 77, 76, 75, 77, 78, 79, 77, 76, 76, 76, 76, 76, 76, 77, 76, 75, 76, 77, 77, 76, 75, 76, 78, 78, 78, 78, 78, 77, 76, 76, 76, 78, 78, 78, 78, 76, 76, 77, 77, 77, 78, 78, 78, 78, 78, 77, 77, 77, 77, 77, 78, 77, 77, 78, 79, 80, 82, 84, 84, 84, 81, 80, 80, 79, 80, 81, 81, 81, 81, 83, 83, 82, 80, 78, 79, 79, 79, 79, 79, 79, 80, 82, 82, 84, 88, 90, 91, 91, 92, 93, 93, 93, 92, 91, 89, 87, 85, 84, 85, 85, 88, 91, 93, 93, 93, 91, 91, 90, 90, 90, 88, 88, 88, 86, 84, 82, 80, 80, 80, 80, 78, 77, 76, 76, 77, 78, 77, 76, 75, 75, 76, 76, 76, 74, 73, 73, 75, 76, 77, 76, 76, 76, 74, 72, 71, 70, 71, 71, 72, 72, 71, 70, 69, 68, 68, 67, 67, 68, 68, 67, 67, 68, 69, 72, 71, 70, 69, 68, 67, 67, 68, 68, 68, 68, 67, 68, 68, 68, 68, 69, 70, 70, 69, 68, 67, 68, 69, 69, 69, 71, 72, 71, 70, 70, 72, 74, 75, 74, 74, 72, 71, 70, 70, 70, 71, 71, 71, 72, 72, 72, 71, 69, 69, 69, 69, 70, 71, 72, 73, 73, 74, 76, 77, 76, 76, 76, 75, 74, 74, 74, 74, 74, 73, 72, 72, 72, 70, 69, 70, 70, 71, 71, 71, 71, 75, 75, 78, 80, 80, 80, 79, 79, 78, 76, 75, 75, 74, 75, 75, 76]
  let recordedRRs : [Float] = [792.96875, 749.0234375, 796.875, 810.546875, 699.21875, 686.5234375, 633.7890625, 605.46875, 586.9140625, 612.3046875, 610.3515625, 600.5859375, 609.375, 618.1640625, 604.4921875, 581.0546875, 594.7265625, 611.328125, 629.8828125, 619.140625, 660.15625, 643.5546875, 663.0859375, 687.5, 780.2734375, 818.359375, 816.40625, 779.296875, 765.625, 720.703125, 699.21875, 689.453125, 677.734375, 636.71875, 625.9765625, 664.0625, 1035.15625, 1049.8046875, 903.3203125, 920.8984375, 944.3359375, 812.5, 757.8125, 700.1953125, 680.6640625, 674.8046875, 664.0625, 657.2265625, 708.0078125, 800.78125, 779.296875, 742.1875, 763.671875, 751.953125, 717.7734375, 706.0546875, 724.609375, 720.703125, 700.1953125, 681.640625, 653.3203125, 647.4609375, 640.625, 646.484375, 674.8046875, 710.9375, 844.7265625, 920.8984375, 857.421875, 762.6953125, 712.890625, 670.8984375, 643.5546875, 648.4375, 669.921875, 695.3125, 666.015625, 663.0859375, 656.25, 690.4296875, 858.3984375, 886.71875, 854.4921875, 817.3828125, 793.9453125, 733.3984375, 681.640625, 650.390625, 632.8125, 635.7421875, 661.1328125, 722.65625, 859.375, 773.4375, 786.1328125, 754.8828125, 713.8671875, 712.890625, 695.3125, 707.03125, 748.046875, 907.2265625, 905.2734375, 804.6875, 756.8359375, 772.4609375, 789.0625, 815.4296875, 818.359375, 768.5546875, 755.859375, 736.328125, 708.0078125, 716.796875, 755.859375, 790.0390625, 825.1953125, 901.3671875, 875.0, 890.625, 906.25, 904.296875, 833.984375, 799.8046875, 754.8828125, 715.8203125, 656.25, 646.484375, 627.9296875, 665.0390625, 765.625, 806.640625, 836.9140625, 808.59375, 755.859375, 719.7265625, 653.3203125, 644.53125, 625.9765625, 637.6953125, 715.8203125, 789.0625, 733.3984375, 782.2265625, 809.5703125, 827.1484375, 811.5234375, 791.9921875, 767.578125, 730.46875, 711.9140625, 732.421875, 728.515625, 713.8671875, 691.40625, 663.0859375, 651.3671875, 640.625, 622.0703125, 602.5390625, 596.6796875, 607.421875, 608.3984375, 610.3515625, 893.5546875, 909.1796875, 801.7578125, 907.2265625, 892.578125, 780.2734375, 727.5390625, 698.2421875, 705.078125, 883.7890625, 1006.8359375, 983.3984375, 933.59375, 915.0390625, 890.625, 819.3359375, 767.578125, 738.28125, 721.6796875, 707.03125, 705.078125, 665.0390625, 652.34375, 619.140625, 627.9296875, 626.953125, 679.6875, 809.5703125, 799.8046875, 711.9140625, 699.21875, 708.0078125, 753.90625, 753.90625, 789.0625, 726.5625, 657.2265625, 646.484375, 641.6015625, 664.0625, 739.2578125, 850.5859375, 892.578125, 797.8515625, 809.5703125, 864.2578125, 897.4609375, 815.4296875, 791.015625, 782.2265625, 806.640625, 839.84375, 802.734375, 719.7265625, 725.5859375, 745.1171875, 811.5234375, 870.1171875, 798.828125, 850.5859375, 870.1171875, 862.3046875, 764.6484375, 797.8515625, 820.3125, 873.046875, 785.15625, 718.75, 726.5625, 807.6171875, 880.859375, 893.5546875, 815.4296875, 850.5859375, 834.9609375, 734.375, 769.53125, 776.3671875, 688.4765625, 649.4140625, 670.8984375, 749.0234375, 1044.921875, 951.171875, 883.7890625, 847.65625, 829.1015625, 743.1640625, 772.4609375, 769.53125, 755.859375, 753.90625, 800.78125, 831.0546875, 774.4140625, 759.765625, 789.0625, 788.0859375, 756.8359375, 701.171875, 734.375, 759.765625, 761.71875, 717.7734375, 685.546875, 714.84375, 781.25, 867.1875, 802.734375, 804.6875, 820.3125, 827.1484375, 733.3984375, 686.5234375, 692.3828125, 709.9609375, 785.15625, 781.25, 800.78125, 828.125, 752.9296875, 819.3359375, 849.609375, 785.15625, 807.6171875, 795.8984375, 696.2890625, 669.921875, 684.5703125, 736.328125, 889.6484375, 888.671875, 860.3515625, 772.4609375, 704.1015625, 701.171875, 718.75, 782.2265625, 902.34375, 873.046875, 771.484375, 772.4609375, 808.59375, 820.3125, 799.8046875, 735.3515625, 741.2109375, 786.1328125, 827.1484375, 858.3984375, 768.5546875, 724.609375, 756.8359375, 797.8515625, 865.234375, 852.5390625, 751.953125, 745.1171875, 672.8515625, 643.5546875, 685.546875, 830.078125, 791.9921875, 796.875, 815.4296875, 831.0546875, 829.1015625, 805.6640625, 732.421875, 714.84375, 736.328125, 776.3671875, 781.25, 765.625, 804.6875, 851.5625, 815.4296875, 747.0703125, 769.53125, 789.0625, 755.859375, 707.03125, 731.4453125, 773.4375, 828.125, 760.7421875, 743.1640625, 772.4609375, 820.3125, 832.03125, 794.921875, 745.1171875, 753.90625, 767.578125, 747.0703125, 832.03125, 826.171875, 769.53125, 709.9609375, 712.890625, 701.171875, 690.4296875, 641.6015625, 636.71875, 657.2265625, 740.234375, 819.3359375, 799.8046875, 842.7734375, 858.3984375, 765.625, 783.203125, 765.625, 719.7265625, 688.4765625, 718.75, 730.46875, 765.625, 721.6796875, 677.734375, 666.015625, 695.3125, 814.453125, 887.6953125, 878.90625, 795.8984375, 728.515625, 741.2109375, 767.578125, 770.5078125, 722.65625, 736.328125, 744.140625, 767.578125, 733.3984375, 694.3359375, 647.4609375, 613.28125, 603.515625, 596.6796875, 596.6796875, 593.75, 597.65625, 620.1171875, 639.6484375, 644.53125, 644.53125, 639.6484375, 631.8359375, 628.90625, 603.515625, 627.9296875, 677.734375, 685.546875, 730.46875, 780.2734375, 1003.90625, 872.0703125, 808.59375, 779.296875, 679.6875, 627.9296875, 620.1171875, 619.140625, 602.5390625, 589.84375, 597.65625, 562.5, 705.078125, 711.9140625, 711.9140625, 687.5, 717.7734375, 683.59375, 703.125, 688.4765625, 663.0859375, 665.0390625, 678.7109375, 764.6484375, 921.875, 901.3671875, 875.0, 860.3515625, 871.09375, 820.3125, 771.484375, 690.4296875, 681.640625, 777.34375, 1013.671875, 924.8046875, 883.7890625, 828.125, 778.3203125, 713.8671875, 709.9609375, 752.9296875, 810.546875, 882.8125, 827.1484375, 838.8671875, 839.84375, 714.84375, 683.59375, 686.5234375, 785.15625, 926.7578125, 935.546875, 830.078125, 750.9765625, 720.703125, 708.984375, 739.2578125, 882.8125, 1006.8359375, 1021.484375, 981.4453125, 958.984375, 932.6171875, 916.9921875, 891.6015625, 800.78125, 754.8828125, 738.28125, 740.234375, 817.3828125, 906.25, 996.09375, 989.2578125, 955.078125, 916.015625, 933.59375, 890.625, 851.5625, 849.609375, 890.625, 940.4296875, 904.296875, 822.265625, 771.484375, 750.9765625, 757.8125, 879.8828125, 988.28125, 981.4453125, 964.84375, 954.1015625, 893.5546875, 820.3125, 750.0, 725.5859375, 838.8671875, 934.5703125, 932.6171875, 831.0546875, 865.234375, 940.4296875, 907.2265625, 817.3828125, 771.484375, 764.6484375, 849.609375, 1041.9921875, 1023.4375, 976.5625, 875.9765625, 812.5, 807.6171875, 823.2421875, 829.1015625, 779.296875, 775.390625, 804.6875, 899.4140625, 916.015625, 855.46875, 778.3203125, 727.5390625, 705.078125, 750.0, 869.140625, 992.1875, 986.328125, 967.7734375, 953.125, 904.296875, 823.2421875, 790.0390625, 775.390625, 813.4765625, 887.6953125, 821.2890625, 770.5078125, 803.7109375, 893.5546875, 959.9609375, 969.7265625, 905.2734375, 896.484375, 813.4765625, 760.7421875, 784.1796875, 798.828125, 803.7109375, 795.8984375, 768.5546875, 800.78125, 754.8828125, 673.828125, 663.0859375, 666.9921875, 739.2578125, 904.296875, 966.796875, 944.3359375, 914.0625, 885.7421875, 847.65625, 763.671875, 749.0234375, 769.53125, 846.6796875, 919.921875, 917.96875, 833.0078125, 853.515625, 956.0546875, 960.9375, 912.109375, 795.8984375, 676.7578125, 740.234375, 828.125, 880.859375, 830.078125, 794.921875, 733.3984375, 688.4765625, 665.0390625, 676.7578125, 653.3203125, 677.734375, 716.796875, 718.75, 779.296875, 815.4296875, 777.34375, 817.3828125, 833.0078125, 866.2109375, 888.671875, 864.2578125, 836.9140625, 733.3984375, 657.2265625, 633.7890625, 709.9609375]

}
